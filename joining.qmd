---
title: "Multiple data frames"
author: "Fabrice Rossi"
format: html
---

```{r}
#| message: false
here::i_am("dm-course-git-101.Rproj")
library(here)
```

```{r}
#| message: false
library(ggplot2)
library(dplyr)
library(tidyr)
library(vroom)
```

## Data loading

```{r}
#| message: false
planets <- vroom(here("data","planets.csv"))
stars <- vroom(here("data","stars.csv"))
```

```{r}
sun_to_earth <- 333000
```

## Planet oriented analyses

We look for the planet that has the largest ratio between its mass and the 
mass of its star. We cannot do that using the planets data frame only, we need
to join it with the stars data frame.

### Inner join

In an inner join, we keep only matches between the two data frames (according to
the `join_by` variable(s)). 

```{r}
planet_star <- inner_join(planets, stars, by = join_by(star_number))
```

```{r}
#| message: false
planet_star |>
  mutate(mass_ratio = Mass/(`Relative Mass`*sun_to_earth)) |>
  slice_max(mass_ratio) |>
  select(planet=p_name, star=S_NAME, mass_ratio) |>
  knitr::kable()
```

### Semi and anti join

```{r}
planets_without_star <- anti_join(planets, stars, by = join_by(star_number))
stars_without_planet <- anti_join(stars, planets, by = join_by(star_number))
```

```{r}
stars_with_planets <- semi_join(stars, planets, by = join_by(star_number))
```

We have `r nrow(planets_without_star)` planets without a corresponding star in the
database and `r nrow(stars_without_planet)` stars without planets described in 
the database. 

### Left and right join

```{r}
all_planets <- left_join(planets, stars, by = join_by(star_number))
all_stars <- right_join(planets, stars, by = join_by(star_number))
all_all <- full_join(planets, stars, by = join_by(star_number))
```

## Star oriented analysis
Is a star does not appear in the planet data frame, this means that this star
has no associated habitable planet. We want to compute the distribution of the 
average number of habitable planets per star. Here we are missing the stars
without planet. 

```{r}
planet_star |> 
  summarise(n=n(), .by=star_number) |>
  ggplot(aes(x=n)) +
    geom_bar()
```

```{r}
all_stars |> 
  summarise(n=n(), .by=star_number) |>
  ggplot(aes(x=n)) +
    geom_bar()
```
```{r}
all_stars |>
  summarise(n=sum(!is.na(PLANET_NUMBER)), .by=star_number) |>
  ggplot(aes(x=n)) +
    geom_bar()
```

```{r}
all_stars |>
  summarise(n=n_distinct(PLANET_NUMBER, na.rm = TRUE), .by=star_number) |>
  ggplot(aes(x=n)) +
    geom_bar()
```

